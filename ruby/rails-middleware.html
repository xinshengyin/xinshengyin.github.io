<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>新声音</title>
  
  <link href="/assets/css/application.css" rel="stylesheet" type="text/css" media="all">
  <link href="/assets/css/syntax.css" rel="stylesheet" type="text/css" media="all">
  <link href="/assets/css/style.css" rel="stylesheet" type="text/css" media="all">
  <script src="/assets/js/jquery.js"></script>
  <script src="/assets/js/semantic.js"></script>
</head>

<body class="">

  <div class="ui top attached segment">
  <div class="ui menu secondary">

  

  
  <a href="/" class="item">首页</a>
  

  

  
  <a href="/category" class="item">分类</a>
  

  

  
  <a href="/about" class="item">关于我</a>
  

  
</div>
</div>

<main>
  <div class="ui invisible side">
  <div class="sidebar">
    <div class="ui inverted vertical fluid icon menu">
	<div class="header center link item" id="close_side">
		<i class="content icon"></i>
	</div>
	
	<div class="item ui dropdown">
		<a class="title">
			<i class="alarm outline icon"></i>
			<span>ruby</span>
		</a>
		<div class="menu content">
			
			<a href="/ruby/programer-think-with-product" class="item">工程师的产品观</a>
			
			<a href="/ruby/file-dir-pathname" class="item">理理File/Dir/Pathname（一）</a>
			
			<a href="/ruby/trace-point" class="item">TracePoint介绍</a>
			
			<a href="/ruby/return-break-next" class="item">ruby中的return</a>
			
			<a href="/ruby/ruby-module-position" class="item">如何动态改变某个class的祖先链</a>
			
			<a href="/ruby/object-space" class="item">ObjectSpace介绍</a>
			
			<a href="/ruby/activesupport-notifications-3" class="item">Rails日志实现探索（3）</a>
			
			<a href="/ruby/activesupport-notifications-2" class="item">Rails日志实现探索（2）</a>
			
			<a href="/ruby/activesupport-notifications" class="item">Rails日志实现探索（1）</a>
			
			<a href="/ruby/rails-request" class="item">Rails中的request</a>
			
			<a href="/ruby/rescue-exception" class="item">rescue exception in ruby</a>
			
			<a href="/ruby/ruby-observer-pattern" class="item">设计模式之观察者模式</a>
			
			<a href="/ruby/ruby-require" class="item">require 的故事</a>
			
			<a href="/ruby/ruby-code-and-decode" class="item">ruby中的编码</a>
			
			<a href="/ruby/research-ruby" class="item">研究ruby的一些小技巧</a>
			
			<a href="/ruby/rails-middleware" class="item">Rails中间件</a>
			
			<a href="/ruby/ruby-serialize" class="item">ruby对象的序列化</a>
			
			<a href="/ruby/activesupport-message-verifier" class="item">ActiveSupport宝藏之MessageVerifier</a>
			
			<a href="/ruby/how-to-write-rakefile" class="item">如何写rakefile</a>
			
			<a href="/ruby/ruby-env" class="item">Ruby on Rails 环境及准备</a>
			
			<a href="/ruby/rack-based-app-boot" class="item">基于Rack的项目初始化</a>
			
		</div>
	</div>
	
	<div class="item ui dropdown">
		<a class="title">
			<i class="alarm outline icon"></i>
			<span>git</span>
		</a>
		<div class="menu content">
			
			<a href="/git/remove-git-history" class="item">如何移除某次提交之前的版本历史</a>
			
			<a href="/git/git-sheet" class="item">Git 不常用的好用的命令</a>
			
			<a href="/git/git-skill-ignore" class="item">Git高级技巧之忽略文件</a>
			
		</div>
	</div>
	
	<div class="item ui dropdown">
		<a class="title">
			<i class="alarm outline icon"></i>
			<span>database</span>
		</a>
		<div class="menu content">
			
			<a href="/database/mysql-sheet" class="item">Mysql数据库编码</a>
			
			<a href="/database/migrate-from-mongodb-to-mysql" class="item">从mongodb向mysql迁移数据</a>
			
		</div>
	</div>
	
</div>
  </div>
  <div class="content">
    <div class="ui grid">
  <div class="sixteen wide column">

    <h1 class="ui top attached center aligned header">
      Rails中间件

      
    </h1>

    <div class="ui attached segment">
    <h2 id="rails-">rails 常见中间件介绍</h2>

<h3 id="rack">Rack中定义的中间件</h3>

<h4 id="racklock"><code class="highlighter-rouge">Rack::Lock</code></h4>
<p>线程锁, 保证 rails 代码单线程运行, 同时设置 env[‘rack.multithread’] = false, 你可以通过设置 config.allow_concurrency = true 来去掉该中间件</p>

<h4 id="rackruntime"><code class="highlighter-rouge">Rack::Runtime</code></h4>
<p>统计运行时间, 放在 response 的 “X-Runtime” header 中</p>

<h4 id="racksendfile"><code class="highlighter-rouge">Rack::Sendfile</code></h4>
<p>如果返回数据已经放在一个文件里边了(比如生成的 PDF), 则可以让 nginx 服务器直接从该文件读取，降低系统消耗</p>

<h4 id="rackmethodoverride"><code class="highlighter-rouge">Rack::MethodOverride</code></h4>
<p>支持用 POST 来模拟 PUT, DELETE, …, 可以在 POST 使用 _method 参数，也可以使用 HTTP 头 “HTTP_X_HTTP_METHOD_OVERRIDE”</p>

<h4 id="railsracklogger"><code class="highlighter-rouge">Rails::Rack::Logger</code></h4>
<p>比如 log/development.log 中的这一行 “Started GET “/” for 127.0.0.1 at Wed Sep 15 21:46:51 +0800 2010”</p>

<h3 id="actiondispatch-">ActionDispatch 中定义的中间件</h3>

<h4 id="actiondispatchstatic"><code class="highlighter-rouge">ActionDispatch::Static</code></h4>
<p>静态文件(即 public/的文件)支持, 一般在生产环境下会禁用此功能</p>

<h4 id="actiondispatchshowexceptions"><code class="highlighter-rouge">ActionDispatch::ShowExceptions</code></h4>
<p>截获异常，把异常转换为 HTTP 错误号 (一般转为 500, 但一些特殊异常转到相应的错误号，比如 “ActionController::MethodNotAllowed” 会被转为 405, 同时显示对应的错误页面，对应开发环境，会显示异常的 backtrace, 对于生产环境，则会显示 public/500.html, 对于测试环境，该中间件会被禁用，直接把异常抛出</p>

<h4 id="actiondispatchremoteip"><code class="highlighter-rouge">ActionDispatch::RemoteIp</code></h4>
<p>解决服务器转发, 代理导致客户端真实 IP 丢失的问题，用户的真实IP放在 env[“action_dispatch.remote_ip”]</p>

<h4 id="actiondispatchcallbacks"><code class="highlighter-rouge">ActionDispatch::Callbacks</code></h4>
<p>测试环境下用于检测源文件是否改变, 产品环境下作用不明 (TODO)</p>

<h4 id="actiondispatchcookies"><code class="highlighter-rouge">ActionDispatch::Cookies</code></h4>
<p>cookie 支持</p>

<h4 id="actiondispatchsessioncookiestore"><code class="highlighter-rouge">ActionDispatch::Session::CookieStore</code></h4>
<p>session 支持，此处使用 cookie store</p>

<h4 id="actiondispatchflash"><code class="highlighter-rouge">ActionDispatch::Flash</code></h4>
<p>flash 支持， 参见 http://guides.rubyonrails.org/action_controller_overview.html#the-flash</p>

<h4 id="actiondispatchparamsparser"><code class="highlighter-rouge">ActionDispatch::ParamsParser</code></h4>
<p>分析XML， JSON参数，放到 env[“action_dispatch.request.request_parameters”]</p>

<h4 id="actiondispatchhead"><code class="highlighter-rouge">ActionDispatch::Head</code></h4>
<p>把 HEAD 请求转为 GET 请求, 同时设置 env[“rack.methodoverride.original_method”] = “HEAD”</p>

<h4 id="actiondispatchbeststandardssupport"><code class="highlighter-rouge">ActionDispatch::BestStandardsSupport</code></h4>
<p>设置 HTTP 头: X-UA-Compatible</p>

<h4 id="projectnameapplicationroutes"><code class="highlighter-rouge">ProjectName::Application.routes</code></h4>
<p>终于进入你的 rails 程序了, 开始路由, 同时开始使用 rails 的协议栈</p>

    </div>

  </div>
</div>
  </div>
</div>
</main>

<footer>
  <div class="ui divider"></div>
  <div class="ui center aligned segment basic">
    <p class="text-center text-muted">&copy; 2017 www.xinshengyin.com All rights reserved.  </p>
    <p class="text-center text-muted">版权所有</p>
  </div>
</footer>


  <script src="/assets/js/footer.js"></script>
  <script type="text/javascript" src="http://tajs.qq.com/stats?sId=39431539" charset="UTF-8"></script>
</body>

</html>
